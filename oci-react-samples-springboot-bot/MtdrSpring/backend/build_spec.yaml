version: 0.1
component: build
timeoutInSeconds: 1200
shell: bash
failImmediatelyOnError: true

env:
  variables:
    JAVA_HOME: /usr/lib64/graalvm/graalvm22-ee-java17

  exportedVariables:
    - BuildServiceDemoVersion

steps:
  - type: Command
    name: "CheckoutMainBranch"
    command: git checkout main

  - type: Command
    name: "PullChanges"
    command: git pull origin main

  - type: Command
    name: "ListRootDirectory"
    command: |
      echo "Listing contents of the root directory"
      ls -la

  - type: Command
    name: "ListSourceDirectory"
    command: |
      echo "Listing contents of the source directory"
      ls -la /workspace/Source1

  - type: Command
    name: "ListProjectDirectory"
    command: |
      echo "Listing contents of the project directory"
      ls -la /workspace/Source1/oci-react-samples-springboot-bot

  - type: Command
    name: "Install GraalVM Enterprise 22.x Native Image for Java17"
    command: yum -y install graalvm22-ee-17-native-image

  - type: Command
    name: "Set PATH variable"
    command: export PATH=$JAVA_HOME/bin:$PATH

  - type: Command
    name: "echo test"
    command: (echo $JAVA_HOME)

  - type: Command
    name: "NavigateToBackend"
    command: cd oci-react-samples-springboot-bot/MtdrSpring/backend

  - type: Command
    name: "SourceEnvScript"
    command: |
      echo "Starting to source env.sh"
      source /workspace/Source1/oci-react-samples-springboot-bot/MtdrSpring/env.sh
      echo "MTDRWORKSHOP_LOCATION: $MTDRWORKSHOP_LOCATION"
      echo "DOCKER_REGISTRY: $DOCKER_REGISTRY"

  - type: Command
    name: "RunBuildScript"
    command: |
      source /workspace/Source1/oci-react-samples-springboot-bot/MtdrSpring/env.sh
      cd /workspace/Source1/oci-react-samples-springboot-bot/MtdrSpring/backend
      echo "DOCKER_REGISTRY: $DOCKER_REGISTRY"
      source build.sh

  - type: Command
    name: "RunUndeployScript"
    command: |
      cd oci-react-samples-springboot-bot/MtdrSpring/backend
      source undeploy.sh

  - type: Command
    name: "RunDeployScript"
    command: |
      cd oci-react-samples-springboot-bot/MtdrSpring/backend
      source deploy.sh
